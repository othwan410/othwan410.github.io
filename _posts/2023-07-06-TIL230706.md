---
layout: single,
tilte: "transaction 오류"
---

# transaction 오류

트랜잭션을 써서 좋아요 기능을 구현할 때 count를 저장하는 테이블과 좋아요를 관리하는 테이블 둘 다 일관성있게 업데이트를 하려고했다.  
  
```
router.patch('/posts/:postId/like', authMiddleware, async (req, res) => {
  const { userId } = res.locals.user;
  const { postId } = req.params;

  const post = await Posts.findOne({
    attributes: ['postId', 'likeCount'],
    include: [
      {
        model: Users,
        attributes: ['userId'],
      },
    ],
    where: { postId },
  });
  if (!post) {
    res.status(404).json({
      errorMessage: '존재하지 않는 게시글입니다.',
    });
    return;
  }

  const likes = await Likes.findOne({
    where: { [Op.and]: [{ PostId: postId }, { UserId: userId }] },
  });

  const t = await sequelize.transaction({
    isolationLeverl: Transaction.ISOLATION_LEVELS.READ_COMMITTED,
  });
  try {
    if (!likes) {
      //왜?? why!!!!!!!!!!!!!!!!!!!!!!!!!!!
      // await Posts.update(
      //   { likeCount: post.likeCount + 1 },
      //   { where: { postId } },
      //   { transaction: t }
      // );
      await Likes.create(
        {
          UserId: userId,
          PostId: postId,
        },
        { transaction: t }
      );
      await post.update({ likeCount: post.likeCount + 1 }, { transaction: t });
    } else {
      await Likes.destroy({ where: { postId } }, { transaction: t });
      await post.update({ likeCount: post.likeCount - 1 }, { transaction: t });
    }
  } catch (error) {
    await t.rollback();
    return res
      .status(400)
      .json({ errorMessage: '좋아요 수정에 실패했습니다.' });
  }

  await t.commit();
  return res.status(200).json({ m: 'ㅁㄴㅇㄹㅇㅁㄴㄹ' });
});
```
