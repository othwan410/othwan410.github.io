---
layout: single
title: "Nest.js Passport Strategy 사용"
---

# Passport Strategy 사용

인증 부분을 구현하면서 Passport 라이브러리를 활용하게 됐다.  
다양한 인증 전략을 제공하여, 로그인과 토큰 기반 인증에 유용하다고 하여 활용해보았다.  
그리고 그 과정에서 guard와 strategy을 구현해보았는데,  

 처음에는 가드 파일을 커스텀하여 쓰고있었는데 전략 부분의 validate 메소드가 전혀 쓰이지 않고 있다는 것을 알게되었다.  
 validate는 내가 알기로는 passport의 내부 로직에 자동으로 실행되는 것으로 알고있었는데, 실행되지 않아 내부를 뜯어보며 이해하게 됐다.  

 살펴본 결과 문제는 super.canActivate(context)로 부모클래스를 호출해주지 않아서였다.  
 부모 클래스를 호출해줘야 내부 로직에 의해 strategy 파일을 찾고, 찾은 strategy안에 정의된 로직을 실행시켜준다.  
 그렇게 사용자에 대한 검증까지 전략파일에서 실행하도록 했다.  

 그리고 그 전략파일에서 만약 액세스 토큰이 없다면, 오류를 던져주는데 그 오류를 받아주는 것이 handleRequest라는 메소드 이다.  
 여기서 오류에 대한 정보를 받고, 액세스 토큰이 만료가 되면 리프레시 토큰을 조회해 비교후 재발급 해주도록 구현하였다.  

 passport로 인해 공통된 인증처리와 토큰 재발급까지 가능해 처리할 때 수월해질 수 있었다.
